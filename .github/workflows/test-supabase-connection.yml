name: Test Supabase Connection

on:
  workflow_dispatch:  # Manual trigger only

env:
  PYTHON_VERSION: '3.11'

jobs:
  test-connection:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install psycopg2-binary python-dotenv

      - name: Test Supabase PostgreSQL connection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          python - <<EOF
          import os
          import psycopg2
          from urllib.parse import urlparse

          print("=" * 60)
          print("TEST CONNEXION SUPABASE DEPUIS GITHUB ACTIONS")
          print("=" * 60)

          # Extract project ref from URL
          url = os.getenv('SUPABASE_URL')
          password = os.getenv('SUPABASE_DB_PASSWORD')

          parsed = urlparse(url)
          project_ref = parsed.hostname.split('.')[0]

          print(f"\nProject: {project_ref}")

          # Test configurations
          configs = [
              {
                  "name": "Direct (port 5432)",
                  "host": f"db.{project_ref}.supabase.co",
                  "port": 5432,
                  "user": "postgres"
              },
              {
                  "name": "Pooler (port 6543)",
                  "host": f"db.{project_ref}.supabase.co",
                  "port": 6543,
                  "user": "postgres"
              }
          ]

          success = False

          for config in configs:
              print(f"\n[TEST] {config['name']}")
              print(f"  Host: {config['host']}")
              print(f"  Port: {config['port']}")

              try:
                  conn = psycopg2.connect(
                      host=config['host'],
                      port=config['port'],
                      database='postgres',
                      user=config['user'],
                      password=password,
                      connect_timeout=10
                  )

                  print(f"  ✓ CONNEXION RÉUSSIE!")

                  # Test: create table
                  cursor = conn.cursor()

                  cursor.execute("SELECT version();")
                  version = cursor.fetchone()[0]
                  print(f"  ✓ PostgreSQL version: {version[:60]}...")

                  cursor.execute("""
                      CREATE TABLE IF NOT EXISTS test_github_actions (
                          id SERIAL PRIMARY KEY,
                          test_value TEXT,
                          created_at TIMESTAMP DEFAULT NOW()
                      )
                  """)
                  conn.commit()
                  print(f"  ✓ TABLE CRÉÉE!")

                  # Insert test data
                  cursor.execute("""
                      INSERT INTO test_github_actions (test_value)
                      VALUES ('Test from GitHub Actions')
                  """)
                  conn.commit()
                  print(f"  ✓ DONNÉES INSÉRÉES!")

                  # Read data
                  cursor.execute("SELECT * FROM test_github_actions")
                  rows = cursor.fetchall()
                  print(f"  ✓ LECTURE: {len(rows)} ligne(s)")

                  # Cleanup
                  cursor.execute("DROP TABLE test_github_actions")
                  conn.commit()
                  print(f"  ✓ TABLE SUPPRIMÉE!")

                  cursor.close()
                  conn.close()

                  print("\n" + "=" * 60)
                  print("✅ SUCCESS!")
                  print("GitHub Actions peut se connecter à Supabase!")
                  print("On peut utiliser psycopg2 pour exécuter les .sql!")
                  print("=" * 60)

                  success = True
                  break

              except Exception as e:
                  print(f"  ✗ ÉCHEC: {str(e)[:100]}")

          if not success:
              print("\n" + "=" * 60)
              print("❌ ÉCHEC")
              print("Aucune configuration ne fonctionne")
              print("=" * 60)
              exit(1)
          EOF

      - name: Notify on success
        if: success()
        run: |
          echo "✅ Test réussi!"
          echo "Prêt à adapter l'ETL pour Supabase"

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Test échoué"
          echo "La connexion PostgreSQL ne fonctionne pas depuis GitHub Actions"
