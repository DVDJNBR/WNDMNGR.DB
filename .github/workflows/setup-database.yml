name: Setup Database - Upload & Execute All SQL

on:
  workflow_dispatch:  # Manual trigger

env:
  PYTHON_VERSION: '3.11'

jobs:
  setup-database:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install supabase requests

      - name: Setup Database
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python - <<'EOF'
          import os
          import time
          from pathlib import Path
          from supabase import create_client, Client
          import requests

          print("=" * 60)
          print("SETUP DATABASE - Upload & Execute All SQL")
          print("=" * 60)

          url = os.getenv('SUPABASE_URL')
          key = os.getenv('SUPABASE_SERVICE_ROLE_KEY')

          if not url or not key:
              print("❌ Missing credentials!")
              exit(1)

          # Create Supabase client
          supabase: Client = create_client(url, key)

          # SQL execution order (respects dependencies)
          SQL_CATEGORIES = [
              '01_REFERENCES',      # Reference tables
              '02_ENTITIES',        # Core entities
              '03_RELATIONSHIPS',   # Junction tables
              '04_LOOK_UPS',        # Lookup tables
              '05_FOREIGN_KEYS',    # Foreign key constraints
              '06_METADATA',        # Metadata tables
          ]

          TABLES_DIR = Path('TABLES')

          print(f"\nProject: {url}")
          print(f"SQL Categories: {len(SQL_CATEGORIES)}")
          print()

          total_files = 0
          total_success = 0
          total_failed = 0
          failed_files = []

          for category in SQL_CATEGORIES:
              category_dir = TABLES_DIR / category

              if not category_dir.exists():
                  print(f"⚠ Category not found: {category}")
                  continue

              # Get all .sql files
              sql_files = sorted(category_dir.glob('*.sql'))

              if not sql_files:
                  print(f"⚠ No SQL files in {category}")
                  continue

              print(f"\n{'=' * 60}")
              print(f"{category} ({len(sql_files)} files)")
              print(f"{'=' * 60}")

              for sql_file in sql_files:
                  total_files += 1
                  file_name = sql_file.name
                  storage_path = f"{category}/{file_name}"

                  print(f"\n[{total_files}] {storage_path}")

                  # Step 1: Upload to Storage
                  print(f"  [1/3] Uploading to Storage...")

                  try:
                      with open(sql_file, 'rb') as f:
                          response = supabase.storage.from_('sql-scripts').upload(
                              path=storage_path,
                              file=f,
                              file_options={'content-type': 'text/plain', 'upsert': 'true'}
                          )
                      print(f"  ✓ Uploaded")
                  except Exception as e:
                      print(f"  ✗ Upload failed: {str(e)[:100]}")
                      failed_files.append({'file': storage_path, 'stage': 'upload', 'error': str(e)})
                      total_failed += 1
                      continue

                  # Step 2: Execute via Edge Function
                  print(f"  [2/3] Executing SQL...")

                  try:
                      edge_function_url = f'{url}/functions/v1/execute-sql'

                      exec_response = requests.post(
                          edge_function_url,
                          headers={
                              'Authorization': f'Bearer {key}',
                              'Content-Type': 'application/json'
                          },
                          json={'filePath': storage_path},
                          timeout=30
                      )

                      if exec_response.status_code in [200, 207]:
                          result = exec_response.json()

                          if result.get('success'):
                              print(f"  ✓ Executed ({result['successCount']}/{result['totalStatements']} statements)")
                              total_success += 1
                          else:
                              print(f"  ⚠ Partial success ({result['successCount']}/{result['totalStatements']} statements)")
                              print(f"    Failed: {result['failCount']}")

                              # Show first error
                              for r in result.get('results', []):
                                  if not r.get('success'):
                                      error_msg = r.get('data', {}).get('error', r.get('error', 'Unknown'))
                                      print(f"    Error: {error_msg[:100]}")
                                      break

                              failed_files.append({
                                  'file': storage_path,
                                  'stage': 'execute',
                                  'error': f"Partial failure: {result['failCount']} statements failed"
                              })
                              total_failed += 1
                      else:
                          error_msg = f"HTTP {exec_response.status_code}: {exec_response.text[:100]}"
                          print(f"  ✗ Execution failed: {error_msg}")
                          failed_files.append({'file': storage_path, 'stage': 'execute', 'error': error_msg})
                          total_failed += 1

                  except Exception as e:
                      print(f"  ✗ Execution error: {str(e)[:100]}")
                      failed_files.append({'file': storage_path, 'stage': 'execute', 'error': str(e)})
                      total_failed += 1
                      continue

                  # Small delay between files
                  time.sleep(0.5)

          # Final Report
          print("\n" + "=" * 60)
          print("DATABASE SETUP COMPLETE")
          print("=" * 60)
          print(f"\nTotal files processed: {total_files}")
          print(f"✓ Success: {total_success}")
          print(f"✗ Failed: {total_failed}")

          if failed_files:
              print(f"\nFailed files:")
              for item in failed_files:
                  print(f"  - {item['file']} ({item['stage']})")
                  print(f"    {item['error'][:100]}")

          print("\n" + "=" * 60)

          if total_failed > 0:
              print("⚠ Setup completed with errors")
              exit(1)
          else:
              print("✅ All tables created successfully!")

          EOF
